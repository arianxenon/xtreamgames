<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xtream Games | Ultimate Gaming Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* استایل‌های قبلی را حفظ کرده‌ام و فقط موارد زیر را اضافه کردم */
        
        /* استایل‌های مربوط به سیستم احراز هویت */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .login-modal-content {
            background-color: var(--secondary-dark);
            width: 90%;
            max-width: 450px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            border: 2px solid var(--accent-blue);
        }
        
        .login-header {
            background-color: var(--card-bg);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--accent-blue);
        }
        
        .login-header h2 {
            color: var(--accent-light-blue);
            font-size: 1.8rem;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .login-form-group {
            margin-bottom: 20px;
        }
        
        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            background-color: rgba(19, 26, 45, 0.7);
            border: 2px solid #2a3552;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .login-btn {
            width: 100%;
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background-color: var(--accent-light-blue);
        }
        
        .login-error {
            color: #ff3333;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        
        /* استایل‌های مربوط به نوار کاربر */
        .user-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
            padding: 8px 15px;
            background-color: var(--card-bg);
            border-radius: 8px;
            border-left: 3px solid var(--accent-blue);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-light-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--accent-light-blue);
        }
        
        .logout-btn {
            background-color: rgba(255, 50, 50, 0.7);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background-color: #ff3333;
        }
        
        /* استایل‌های مربوط به حالت نمایش */
        .view-mode-notice {
            background-color: rgba(255, 165, 0, 0.2);
            border: 2px solid #FF9800;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .view-mode-notice i {
            color: #FF9800;
            margin-right: 10px;
        }
        
        /* مخفی کردن دکمه‌های مدیریت در حالت نمایش */
        body.view-mode .add-game-btn,
        body.view-mode .edit-btn,
        body.view-mode .delete-btn,
        body.view-mode #saveBtn,
        body.view-mode #cancelBtn,
        body.view-mode .add-btn,
        body.view-mode .remove-btn,
        body.view-mode #addMusicUrlBtn,
        body.view-mode #addMediaBtn,
        body.view-mode #addLinkBtn {
            display: none !important;
        }
        
        body.view-mode .sidebar {
            opacity: 0.6;
            pointer-events: none;
        }
        
        body.view-mode .sidebar h3::after {
            content: " (View Only)";
            color: #FF9800;
            font-size: 0.8rem;
        }
        
        /* هشدار برای کاربران غیر وارد شده */
        .login-required-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .game-card.view-mode:hover .login-required-overlay {
            display: flex;
        }
        
        .game-actions.view-mode {
            filter: blur(1px);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Modal لاگین -->
    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <div class="login-header">
                <h2><i class="fas fa-gamepad"></i> Xtream Games Admin</h2>
                <p>ورود به پنل مدیریت</p>
            </div>
            <div class="login-body">
                <form id="loginForm">
                    <div class="login-form-group">
                        <label for="username"><i class="fas fa-user"></i> نام کاربری</label>
                        <input type="text" id="loginUsername" class="login-input" placeholder="Enter username" required>
                    </div>
                    <div class="login-form-group">
                        <label for="password"><i class="fas fa-lock"></i> رمز عبور</label>
                        <input type="password" id="loginPassword" class="login-input" placeholder="Enter password" required>
                    </div>
                    <div class="login-error" id="loginError">
                        <i class="fas fa-exclamation-triangle"></i> نام کاربری یا رمز عبور اشتباه است
                    </div>
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    <p>برای مشاهده سایت نیاز به ورود دارید</p>
                    <p style="margin-top: 10px; font-size: 0.8rem; color: #777;">
                        <i class="fas fa-info-circle"></i> حالت نمایش: فقط مشاهده بازی‌ها بدون امکان ویرایش
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Header اصلی -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-gamepad fa-2x" style="color: #0066ff;"></i>
                    <h1>Xtream Games</h1>
                </div>
                
                <!-- نوار کاربر (پس از ورود نمایش داده می‌شود) -->
                <div class="user-bar" id="userBar" style="display: none;">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-name" id="userName">Admin</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
                
                <div class="music-player-container">
                    <!-- بقیه المان‌های هدر بدون تغییر -->
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="container">
        <!-- اعلان حالت نمایش -->
        <div class="view-mode-notice" id="viewModeNotice" style="display: none;">
            <i class="fas fa-eye"></i>
            <strong>حالت نمایش فعال است</strong> - شما در حال مشاهده سایت هستید. برای ویرایش بازی‌ها وارد سیستم شوید.
            <button class="logout-btn" id="loginFromViewBtn" style="background-color: #0066ff; margin-left: 15px; padding: 5px 15px;">
                <i class="fas fa-sign-in-alt"></i> ورود به سیستم
            </button>
        </div>
        
        <div class="main-content">
            <!-- بقیه کد بدون تغییر -->
        </div>
    </div>
    
    <!-- بقیه مودال‌ها و المان‌ها بدون تغییر -->

    <script>
        // ==================== سیستم احراز هویت ====================
        const AUTH_CONFIG = {
            USERNAME: 'arianxenon',
            PASSWORD: '2981354361max',
            STORAGE_KEY: 'xtreamGamesAuth_v1'
        };
        
        class AuthSystem {
            constructor() {
                this.isLoggedIn = false;
                this.user = null;
                this.init();
            }
            
            init() {
                this.loadAuthState();
                this.setupEventListeners();
                this.checkAuth();
            }
            
            loadAuthState() {
                const authData = localStorage.getItem(AUTH_CONFIG.STORAGE_KEY);
                if (authData) {
                    try {
                        const data = JSON.parse(authData);
                        if (data.isLoggedIn && data.user && data.expires > Date.now()) {
                            this.isLoggedIn = true;
                            this.user = data.user;
                        } else {
                            // اگر زمان انقضا گذشته باشد
                            this.logout();
                        }
                    } catch (e) {
                        this.logout();
                    }
                }
            }
            
            saveAuthState() {
                const authData = {
                    isLoggedIn: this.isLoggedIn,
                    user: this.user,
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 ساعت
                };
                localStorage.setItem(AUTH_CONFIG.STORAGE_KEY, JSON.stringify(authData));
            }
            
            login(username, password) {
                if (username === AUTH_CONFIG.USERNAME && password === AUTH_CONFIG.PASSWORD) {
                    this.isLoggedIn = true;
                    this.user = {
                        username: username,
                        name: 'Admin',
                        avatar: 'A'
                    };
                    this.saveAuthState();
                    return true;
                }
                return false;
            }
            
            logout() {
                this.isLoggedIn = false;
                this.user = null;
                localStorage.removeItem(AUTH_CONFIG.STORAGE_KEY);
            }
            
            isAuthenticated() {
                return this.isLoggedIn;
            }
            
            setupEventListeners() {
                // فرم لاگین
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = document.getElementById('loginUsername').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    if (this.login(username, password)) {
                        this.hideLoginModal();
                        this.updateUI();
                        showToast('با موفقیت وارد شدید!', 'success');
                    } else {
                        document.getElementById('loginError').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('loginError').style.display = 'none';
                        }, 3000);
                    }
                });
                
                // دکمه خروج
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (confirm('آیا می‌خواهید از سیستم خارج شوید؟')) {
                        this.logout();
                        this.showLoginModal();
                        this.updateUI();
                        showToast('از سیستم خارج شدید.', 'info');
                    }
                });
                
                // دکمه ورود از حالت نمایش
                document.getElementById('loginFromViewBtn').addEventListener('click', () => {
                    this.showLoginModal();
                });
            }
            
            checkAuth() {
                if (!this.isAuthenticated()) {
                    this.showLoginModal();
                } else {
                    this.hideLoginModal();
                }
                this.updateUI();
            }
            
            showLoginModal() {
                document.getElementById('loginModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            hideLoginModal() {
                document.getElementById('loginModal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            updateUI() {
                const isAuthenticated = this.isAuthenticated();
                
                // نوار کاربر
                const userBar = document.getElementById('userBar');
                const viewModeNotice = document.getElementById('viewModeNotice');
                
                if (isAuthenticated) {
                    // حالت مدیریت
                    document.body.classList.remove('view-mode');
                    userBar.style.display = 'flex';
                    viewModeNotice.style.display = 'none';
                    
                    // آپدیت اطلاعات کاربر
                    document.getElementById('userName').textContent = this.user.name;
                    document.getElementById('userAvatar').textContent = this.user.avatar;
                } else {
                    // حالت نمایش
                    document.body.classList.add('view-mode');
                    userBar.style.display = 'none';
                    viewModeNotice.style.display = 'block';
                }
            }
            
            // بررسی دسترسی برای عملیات حساس
            checkAccess() {
                if (!this.isAuthenticated()) {
                    showToast('برای انجام این عمل باید وارد سیستم شوید.', 'error');
                    return false;
                }
                return true;
            }
        }
        
        // ==================== تغییرات در سیستم اصلی ====================
        
        // ایجاد نمونه از سیستم احراز هویت
        const authSystem = new AuthSystem();
        
        // تغییر در توابع حساس برای بررسی دسترسی
        function checkAuthAndExecute(callback) {
            if (authSystem.checkAccess()) {
                callback();
            }
        }
        
        // بازنویسی توابع حساس با بررسی احراز هویت
        function saveGame(e) {
            e.preventDefault();
            
            if (!authSystem.isAuthenticated()) {
                showToast('برای ذخیره بازی باید وارد سیستم شوید.', 'error');
                return;
            }
            
            // بقیه کد تابع بدون تغییر
            if (!gameNameInput.value.trim() || !mainImageInput.value.trim()) {
                alert('Please enter game name and main image URL');
                return;
            }
            
            const gameData = {
                id: currentGameId || Date.now(),
                name: gameNameInput.value.trim(),
                mainImage: mainImageInput.value.trim(),
                description: gameDescriptionInput.value.trim(),
                media: [...mediaItems],
                downloadLinks: [...downloadLinkItems],
                updatedAt: new Date().toISOString()
            };
            
            if (currentGameId) {
                db.updateGame(currentGameId, gameData);
            } else {
                db.addGame(gameData);
            }
            
            loadGames();
            resetForm();
            updateDatabaseStatus();
            
            showToast(`Game "${gameData.name}" saved successfully!`);
        }
        
        function deleteGame(id) {
            if (!authSystem.isAuthenticated()) {
                showToast('برای حذف بازی باید وارد سیستم شوید.', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this game?')) return;
            
            db.deleteGame(id);
            loadGames();
            
            if (currentGameId === id) {
                resetForm();
            }
            
            showToast('Game deleted successfully!');
            updateDatabaseStatus();
        }
        
        function addMusicToPlaylist() {
            if (!authSystem.isAuthenticated()) {
                showToast('برای افزودن موسیقی باید وارد سیستم شوید.', 'error');
                return;
            }
            
            const url = musicUrlInput.value.trim();
            if (!url) {
                alert('Please enter a music URL');
                return;
            }
            
            // بقیه کد تابع بدون تغییر
            if (!url.endsWith('.mp3') && !url.includes('audio/mpeg')) {
                if (!confirm('This might not be an MP3 file. Continue anyway?')) {
                    return;
                }
            }
            
            const title = prompt('Enter song title:', 'New Track');
            if (!title) return;
            
            const newTrack = {
                title: title,
                url: url
            };
            
            musicPlaylist.push(newTrack);
            db.saveMusicPlaylist(musicPlaylist);
            renderMusicPlaylist();
            
            musicUrlInput.value = '';
            
            if (musicPlaylist.length === 1) {
                currentMusicIndex = 0;
                playMusic(currentMusicIndex);
            }
            
            showToast(`"${title}" added to playlist!`);
            updateDatabaseStatus();
        }
        
        // تغییر Event Listeners برای دکمه‌های حساس
        function setupEventListeners() {
            // تغییر برای دکمه‌های حساس
            addNewGameBtn.addEventListener('click', () => {
                if (authSystem.isAuthenticated()) {
                    resetForm();
                } else {
                    showToast('برای افزودن بازی باید وارد سیستم شوید.', 'error');
                    authSystem.showLoginModal();
                }
            });
            
            addMediaBtn.addEventListener('click', () => {
                if (authSystem.isAuthenticated()) {
                    addMediaItem();
                } else {
                    showToast('برای افزودن مدیا باید وارد سیستم شوید.', 'error');
                }
            });
            
            addMusicUrlBtn.addEventListener('click', () => {
                if (authSystem.isAuthenticated()) {
                    addMusicToPlaylist();
                } else {
                    showToast('برای افزودن موسیقی باید وارد سیستم شوید.', 'error');
                }
            });
            
            addLinkBtn.addEventListener('click', () => {
                if (authSystem.isAuthenticated()) {
                    addDownloadLink();
                } else {
                    showToast('برای افزودن لینک باید وارد سیستم شوید.', 'error');
                }
            });
            
            addMusicBtn.addEventListener('click', () => {
                if (authSystem.isAuthenticated()) {
                    musicUrlInput.scrollIntoView({behavior: 'smooth'});
                } else {
                    showToast('برای مدیریت موسیقی باید وارد سیستم شوید.', 'error');
                }
            });
            
            gameForm.addEventListener('submit', saveGame);
            cancelBtn.addEventListener('click', resetForm);
            
            // بقیه Event Listeners بدون تغییر
            // ...
        }
        
        // تغییر در تابع renderGames برای مخفی کردن دکمه‌های ویرایش در حالت نمایش
        function renderGames() {
            gamesGrid.innerHTML = '';
            
            if (games.length === 0) {
                emptyState.style.display = 'block';
                gamesGrid.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            
            const isAuthenticated = authSystem.isAuthenticated();
            
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = `game-card ${!isAuthenticated ? 'view-mode' : ''}`;
                
                gameCard.innerHTML = `
                    <div class="game-image-container">
                        <img src="${game.mainImage}" alt="${game.name}" class="game-image" onerror="this.src='https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1080&h=1920&fit=crop'">
                        
                        <!-- Overlay برای هشدار لاگین -->
                        ${!isAuthenticated ? `
                            <div class="login-required-overlay">
                                <div>
                                    <i class="fas fa-lock fa-2x" style="margin-bottom: 10px;"></i>
                                    <p>برای ویرایش این بازی وارد سیستم شوید</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="game-overlay">
                            <div class="game-title">${game.name}</div>
                            <div class="game-actions ${!isAuthenticated ? 'view-mode' : ''}">
                                ${isAuthenticated ? `
                                    <button class="action-btn edit-btn" onclick="editGame(${game.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="action-btn" onclick="viewGameDetails(${game.id})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn share-game-btn" onclick="shareGame(${game.id})">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteGame(${game.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                ` : `
                                    <button class="action-btn" onclick="viewGameDetails(${game.id})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn share-game-btn" onclick="shareGame(${game.id})">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                gameCard.addEventListener('click', function(e) {
                    if (!e.target.closest('.game-actions')) {
                        viewGameDetails(game.id);
                    }
                });
                
                gamesGrid.appendChild(gameCard);
            });
        }
        
        // تابع editGame نیز نیاز به بررسی دسترسی دارد
        function editGame(id) {
            if (!authSystem.isAuthenticated()) {
                showToast('برای ویرایش بازی باید وارد سیستم شوید.', 'error');
                authSystem.showLoginModal();
                return;
            }
            
            const game = games.find(g => g.id === id);
            if (!game) return;
            
            currentGameId = id;
            formTitle.textContent = 'Edit Game';
            gameIdInput.value = game.id;
            gameNameInput.value = game.name;
            mainImageInput.value = game.mainImage;
            gameDescriptionInput.value = game.description || '';
            mediaItems = game.media || [];
            downloadLinkItems = game.downloadLinks || [];
            
            renderMediaPreview();
            renderDownloadLinks();
        }
        
        // بارگذاری اولیه با بررسی وضعیت احراز هویت
        document.addEventListener('DOMContentLoaded', function() {
            // ابتدا سیستم احراز هویت را راه‌اندازی می‌کنیم
            authSystem.checkAuth();
            
            // سپس بقیه سیستم را راه‌اندازی می‌کنیم
            loadGames();
            loadMusicPlaylist();
            setupEventListeners();
            loadDefaultMusic();
            updateSiteUrl();
            updateDatabaseStatus();
            
            // لود از لینک هوشمند اگر موجود باشد
            loadFromSmartLink();
            
            // Load sample games if empty
            if (db.getGames().length === 0) {
                loadSampleGames();
            }
        });
        
        // بقیه توابع بدون تغییر باقی می‌مانند
        // ...
    </script>
</body>
</html>
